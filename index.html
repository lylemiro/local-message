<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bluetooth Web Messenger</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <style>
        .chat-bubble-sent {
            border-radius: 1.125rem 1.125rem 0 1.125rem;
            max-width: 66.666667%;
        }
        .chat-bubble-received {
            border-radius: 1.125rem 1.125rem 1.125rem 0;
            max-width: 66.666667%;
        }
        #bluetooth-devices {
            max-height: 200px;
            overflow-y: auto;
        }
        .bluetooth-device {
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .bluetooth-device:hover {
            background-color: #f3f4f6;
        }
        .connection-status {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .connected {
            background-color: #10B981;
        }
        .disconnected {
            background-color: #EF4444;
        }
        .connecting {
            background-color: #F59E0B;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <div id="app" class="container mx-auto px-4 py-8">
        <!-- Auth Section -->
        <div id="auth-section" class="max-w-md mx-auto bg-white rounded-xl shadow-md overflow-hidden p-6">
            <h1 class="text-2xl font-bold text-center mb-6">Bluetooth Messenger</h1>
            <div id="login-form">
                <h2 class="text-xl font-semibold mb-4">Login</h2>
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2" for="login-username">Username</label>
                    <input class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" id="login-username" type="text" placeholder="Username">
                </div>
                <div class="mb-6">
                    <label class="block text-gray-700 text-sm font-bold mb-2" for="login-password">Password</label>
                    <input class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 mb-3 leading-tight focus:outline-none focus:shadow-outline" id="login-password" type="password" placeholder="Password">
                </div>
                <div class="flex items-center justify-between">
                    <button class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline" id="login-button">Sign In</button>
                    <button class="inline-block align-baseline font-bold text-sm text-blue-500 hover:text-blue-800" id="show-register">Register</button>
                </div>
            </div>
            <div id="register-form" class="hidden">
                <h2 class="text-xl font-semibold mb-4">Register</h2>
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2" for="register-username">Username</label>
                    <input class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" id="register-username" type="text" placeholder="Username">
                </div>
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2" for="register-password">Password</label>
                    <input class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 mb-3 leading-tight focus:outline-none focus:shadow-outline" id="register-password" type="password" placeholder="Password">
                </div>
                <div class="mb-6">
                    <label class="block text-gray-700 text-sm font-bold mb-2" for="register-confirm">Confirm Password</label>
                    <input class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 mb-3 leading-tight focus:outline-none focus:shadow-outline" id="register-confirm" type="password" placeholder="Confirm Password">
                </div>
                <div class="flex items-center justify-between">
                    <button class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline" id="register-button">Register</button>
                    <button class="inline-block align-baseline font-bold text-sm text-blue-500 hover:text-blue-800" id="show-login">Back to Login</button>
                </div>
            </div>
        </div>

        <!-- Main App Section -->
        <div id="main-section" class="hidden max-w-4xl mx-auto bg-white rounded-xl shadow-md overflow-hidden">
            <!-- Bluetooth Setup -->
            <div id="bluetooth-setup" class="p-6 border-b">
                <h2 class="text-xl font-semibold mb-4">Bluetooth Connection</h2>
                <div class="flex flex-wrap items-center mb-4">
                    <div class="w-full mb-4">
                        <div class="flex space-x-2">
                            <button class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded" id="scan-bluetooth">Scan for Devices</button>
                            <button class="bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded" id="make-discoverable">Make Discoverable</button>
                        </div>
                    </div>
                </div>
                <div class="mb-4">
                    <h3 class="font-medium mb-2">Available Devices:</h3>
                    <div id="bluetooth-devices" class="border rounded p-2">
                        <p class="text-gray-500 text-center py-4">No devices found. Click "Scan for Devices" to search.</p>
                    </div>
                </div>
                <div class="mb-4">
                    <h3 class="font-medium mb-2">Connected Devices:</h3>
                    <div id="connected-devices" class="border rounded p-2">
                        <p class="text-gray-500 text-center py-4">No devices connected.</p>
                    </div>
                </div>
            </div>

            <!-- Chat Section -->
            <div class="flex flex-col h-96">
                <!-- Chat Header -->
                <div class="bg-gray-200 px-4 py-2 flex justify-between items-center">
                    <h3 class="font-semibold">Bluetooth Chat</h3>
                    <span id="connection-status" class="bg-red-500 text-white px-2 py-1 rounded-full text-xs">Disconnected</span>
                </div>

                <!-- Messages Container -->
                <div id="messages-container" class="flex-1 overflow-y-auto p-4 bg-gray-50">
                    <!-- Messages will be appended here -->
                </div>

                <!-- Message Input -->
                <div class="border-t p-4 bg-white">
                    <div class="flex">
                        <input type="text" id="message-input" placeholder="Type your message..." class="flex-1 border rounded-l py-2 px-4 focus:outline-none">
                        <input type="file" id="media-input" accept="image/*,video/*" class="hidden">
                        <button id="media-button" class="bg-gray-200 hover:bg-gray-300 px-3 border-y">ðŸ“Ž</button>
                        <button id="send-button" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-r">Send</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // App State
        const appState = {
            currentUser: null,
            bluetoothServer: null,
            bluetoothCharacteristic: null,
            connectedDevices: new Map(),
            encryptionKey: null,
            isConnected: false,
            serviceUuid: '0000fff0-0000-1000-8000-00805f9b34fb',
            characteristicUuid: '0000fff1-0000-1000-8000-00805f9b34fb'
        };

        // DOM Elements
        const elements = {
            authSection: document.getElementById('auth-section'),
            mainSection: document.getElementById('main-section'),
            loginForm: document.getElementById('login-form'),
            registerForm: document.getElementById('register-form'),
            loginButton: document.getElementById('login-button'),
            registerButton: document.getElementById('register-button'),
            showRegister: document.getElementById('show-register'),
            showLogin: document.getElementById('show-login'),
            scanBluetoothButton: document.getElementById('scan-bluetooth'),
            makeDiscoverableButton: document.getElementById('make-discoverable'),
            bluetoothDevices: document.getElementById('bluetooth-devices'),
            connectedDevices: document.getElementById('connected-devices'),
            messagesContainer: document.getElementById('messages-container'),
            messageInput: document.getElementById('message-input'),
            sendButton: document.getElementById('send-button'),
            mediaButton: document.getElementById('media-button'),
            mediaInput: document.getElementById('media-input'),
            connectionStatus: document.getElementById('connection-status')
        };

        // Local Storage Keys
        const STORAGE_KEYS = {
            USERS: 'bluetoothMessengerUsers',
            MESSAGES: 'bluetoothMessengerMessages',
            CURRENT_USER: 'bluetoothMessengerCurrentUser'
        };

        // Initialize the app
        function initApp() {
            // Check if there's a logged-in user
            const currentUser = localStorage.getItem(STORAGE_KEYS.CURRENT_USER);
            
            if (currentUser) {
                appState.currentUser = currentUser;
                elements.authSection.classList.add('hidden');
                elements.mainSection.classList.remove('hidden');
                loadMessages();
            } else {
                // Show first-time instructions
                setTimeout(() => {
                    alert('Welcome to Bluetooth Web Messenger!\n\nINSTRUCTIONS:\n1. Register or login with your credentials\n2. Click "Scan for Devices" to find nearby Bluetooth devices\n3. Click "Make Discoverable" to allow others to find your device\n4. Connect to devices to start messaging securely!');
                }, 500);
            }
            
            setupEventListeners();
            checkBluetoothAvailability();
        }

        // Check if Bluetooth is available
        function checkBluetoothAvailability() {
            if (!navigator.bluetooth) {
                alert('Web Bluetooth API is not available in this browser. Please use Chrome or Edge on desktop or Android.');
                elements.scanBluetoothButton.disabled = true;
                elements.makeDiscoverableButton.disabled = true;
            }
        }

        // Set up event listeners
        function setupEventListeners() {
            // Auth events
            elements.showRegister.addEventListener('click', () => {
                elements.loginForm.classList.add('hidden');
                elements.registerForm.classList.remove('hidden');
            });
            
            elements.showLogin.addEventListener('click', () => {
                elements.registerForm.classList.add('hidden');
                elements.loginForm.classList.remove('hidden');
            });
            
            elements.loginButton.addEventListener('click', handleLogin);
            elements.registerButton.addEventListener('click', handleRegister);
            
            // Bluetooth events
            elements.scanBluetoothButton.addEventListener('click', scanForDevices);
            elements.makeDiscoverableButton.addEventListener('click', makeDiscoverable);
            
            // Message events
            elements.sendButton.addEventListener('click', sendMessage);
            elements.messageInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') sendMessage();
            });
            
            // Media events
            elements.mediaButton.addEventListener('click', () => elements.mediaInput.click());
            elements.mediaInput.addEventListener('change', handleMediaUpload);
        }

        // Handle user registration
        function handleRegister() {
            const username = document.getElementById('register-username').value;
            const password = document.getElementById('register-password').value;
            const confirm = document.getElementById('register-confirm').value;
            
            if (!username || !password) {
                alert('Please enter both username and password');
                return;
            }
            
            if (password !== confirm) {
                alert('Passwords do not match');
                return;
            }
            
            // Get existing users or initialize empty object
            const users = JSON.parse(localStorage.getItem(STORAGE_KEYS.USERS) || '{}');
            
            if (users[username]) {
                alert('Username already exists');
                return;
            }
            
            // Store user (in a real app, you'd hash the password)
            users[username] = { password, createdAt: new Date().toISOString() };
            localStorage.setItem(STORAGE_KEYS.USERS, JSON.stringify(users));
            
            alert('Registration successful! Please login.');
            elements.registerForm.classList.add('hidden');
            elements.loginForm.classList.remove('hidden');
        }

        // Handle user login
        function handleLogin() {
            const username = document.getElementById('login-username').value;
            const password = document.getElementById('login-password').value;
            
            if (!username || !password) {
                alert('Please enter both username and password');
                return;
            }
            
            // Get existing users
            const users = JSON.parse(localStorage.getItem(STORAGE_KEYS.USERS) || '{}');
            
            if (!users[username] || users[username].password !== password) {
                alert('Invalid username or password');
                return;
            }
            
            // Login successful
            appState.currentUser = username;
            localStorage.setItem(STORAGE_KEYS.CURRENT_USER, username);
            
            // Derive encryption key from password (simplified for demo)
            appState.encryptionKey = CryptoJS.SHA256(password).toString();
            
            elements.authSection.classList.add('hidden');
            elements.mainSection.classList.remove('hidden');
            
            loadMessages();
        }

        // Scan for Bluetooth devices
        async function scanForDevices() {
            if (!navigator.bluetooth) {
                alert('Web Bluetooth API is not available in this browser.');
                return;
            }
            
            try {
                elements.scanBluetoothButton.disabled = true;
                elements.scanBluetoothButton.textContent = 'Scanning...';
                
                // Request a Bluetooth device
                const device = await navigator.bluetooth.requestDevice({
                    acceptAllDevices: true,
                    optionalServices: [appState.serviceUuid]
                });
                
                // Connect to the GATT Server
                const server = await device.gatt.connect();
                
                // Get the service
                const service = await server.getPrimaryService(appState.serviceUuid);
                
                // Get the characteristic
                const characteristic = await service.getCharacteristic(appState.characteristicUuid);
                
                // Start notifications
                await characteristic.startNotifications();
                
                // Add event listener for incoming data
                characteristic.addEventListener('characteristicvaluechanged', handleIncomingData);
                
                // Store the connection
                appState.connectedDevices.set(device.id, {
                    device,
                    server,
                    service,
                    characteristic
                });
                
                // Update UI
                updateConnectedDevicesList();
                updateConnectionStatus(true);
                
                // Simulate receiving a welcome message
                simulateIncomingMessage({
                    id: Date.now(),
                    sender: device.name || 'Bluetooth Device',
                    text: `Connected to ${device.name || 'Bluetooth Device'}`,
                    timestamp: new Date().toISOString(),
                    type: 'text'
                });
                
            } catch (error) {
                console.error('Bluetooth error:', error);
                alert('Error connecting to Bluetooth device: ' + error.message);
            } finally {
                elements.scanBluetoothButton.disabled = false;
                elements.scanBluetoothButton.textContent = 'Scan for Devices';
            }
        }

        // Make device discoverable
        async function makeDiscoverable() {
            if (!navigator.bluetooth) {
                alert('Web Bluetooth API is not available in this browser.');
                return;
            }
            
            try {
                // This is a simplified implementation
                // In a real app, you would advertise your device
                alert('Your device is now discoverable to nearby Bluetooth devices. Other users can now find and connect to your device.');
                
                // Simulate being discovered (this would be handled by the Bluetooth API)
                simulateDeviceDiscovery();
                
            } catch (error) {
                console.error('Bluetooth error:', error);
                alert('Error making device discoverable: ' + error.message);
            }
        }

        // Simulate device discovery (for demo purposes)
        function simulateDeviceDiscovery() {
            // In a real implementation, this would be handled by the Bluetooth API
            // For demo purposes, we'll simulate finding a device
            setTimeout(() => {
                const simulatedDevices = [
                    { id: 'device-1', name: 'Phone User' },
                    { id: 'device-2', name: 'Tablet User' },
                    { id: 'device-3', name: 'Laptop User' }
                ];
                
                updateBluetoothDevicesList(simulatedDevices);
            }, 2000);
        }

        // Update Bluetooth devices list
        function updateBluetoothDevicesList(devices) {
            if (devices.length === 0) {
                elements.bluetoothDevices.innerHTML = '<p class="text-gray-500 text-center py-4">No devices found.</p>';
                return;
            }
            
            elements.bluetoothDevices.innerHTML = '';
            devices.forEach(device => {
                const deviceElement = document.createElement('div');
                deviceElement.className = 'bluetooth-device p-2 border-b';
                deviceElement.innerHTML = `
                    <div class="flex justify-between items-center">
                        <span>${device.name}</span>
                        <button class="connect-device bg-blue-500 hover:bg-blue-700 text-white text-xs font-bold py-1 px-2 rounded" data-id="${device.id}">Connect</button>
                    </div>
                `;
                elements.bluetoothDevices.appendChild(deviceElement);
                
                // Add event listener to connect button
                deviceElement.querySelector('.connect-device').addEventListener('click', () => {
                    connectToDevice(device);
                });
            });
        }

        // Connect to a device (simulated for demo)
        function connectToDevice(device) {
            // In a real implementation, this would connect via Bluetooth
            // For demo purposes, we'll simulate a connection
            alert(`Connecting to ${device.name}...`);
            
            // Simulate connection process
            setTimeout(() => {
                appState.connectedDevices.set(device.id, {
                    device,
                    name: device.name
                });
                
                updateConnectedDevicesList();
                updateConnectionStatus(true);
                
                // Simulate receiving a welcome message
                simulateIncomingMessage({
                    id: Date.now(),
                    sender: device.name,
                    text: `Connected to ${device.name}`,
                    timestamp: new Date().toISOString(),
                    type: 'text'
                });
            }, 1500);
        }

        // Update connected devices list
        function updateConnectedDevicesList() {
            if (appState.connectedDevices.size === 0) {
                elements.connectedDevices.innerHTML = '<p class="text-gray-500 text-center py-4">No devices connected.</p>';
                return;
            }
            
            elements.connectedDevices.innerHTML = '';
            appState.connectedDevices.forEach((device, id) => {
                const deviceElement = document.createElement('div');
                deviceElement.className = 'connected-device p-2 border-b';
                deviceElement.innerHTML = `
                    <div class="flex items-center">
                        <span class="connection-status connected"></span>
                        <span>${device.name || device.device.name}</span>
                    </div>
                `;
                elements.connectedDevices.appendChild(deviceElement);
            });
        }

        // Handle incoming data from Bluetooth
        function handleIncomingData(event) {
            // In a real implementation, this would decode the incoming data
            // For demo purposes, we'll simulate receiving a message
            const value = event.target.value;
            const decoder = new TextDecoder();
            const message = decoder.decode(value);
            
            // Parse the message (assuming it's JSON)
            try {
                const parsedMessage = JSON.parse(message);
                simulateIncomingMessage(parsedMessage);
            } catch (error) {
                console.error('Error parsing incoming message:', error);
            }
        }

        // Update connection status UI
        function updateConnectionStatus(connected) {
            appState.isConnected = connected;
            if (connected) {
                elements.connectionStatus.textContent = 'Connected';
                elements.connectionStatus.classList.remove('bg-red-500');
                elements.connectionStatus.classList.add('bg-green-500');
            } else {
                elements.connectionStatus.textContent = 'Disconnected';
                elements.connectionStatus.classList.remove('bg-green-500');
                elements.connectionStatus.classList.add('bg-red-500');
            }
        }

        // Encrypt message
        function encryptMessage(text) {
            return CryptoJS.AES.encrypt(text, appState.encryptionKey).toString();
        }

        // Decrypt message
        function decryptMessage(ciphertext) {
            try {
                const bytes = CryptoJS.AES.decrypt(ciphertext, appState.encryptionKey);
                return bytes.toString(CryptoJS.enc.Utf8);
            } catch (e) {
                console.error('Decryption error:', e);
                return '[Unable to decrypt message]';
            }
        }

        // Send message
        function sendMessage() {
            const messageText = elements.messageInput.value.trim();
            if (!messageText) return;
            
            if (appState.connectedDevices.size === 0) {
                alert('Not connected to any devices. Please connect to a Bluetooth device first.');
                return;
            }
            
            const message = {
                id: Date.now(),
                sender: appState.currentUser,
                text: messageText,
                timestamp: new Date().toISOString(),
                type: 'text'
            };
            
            // Encrypt message
            const encryptedMessage = encryptMessage(messageText);
            
            // In a real implementation, this would send via Bluetooth
            // For this demo, we'll just store it locally and simulate sending
            sendViaBluetooth(message);
            saveMessage(message);
            displayMessage(message);
            
            // Clear input
            elements.messageInput.value = '';
        }

        // Send message via Bluetooth (simulated for demo)
        function sendViaBluetooth(message) {
            // In a real implementation, this would send data via the Bluetooth characteristic
            // For demo purposes, we'll just log it
            console.log('Sending via Bluetooth:', message);
            
            // Simulate sending to all connected devices
            appState.connectedDevices.forEach((device, id) => {
                // This would actually use device.characteristic.writeValue() in a real implementation
                console.log(`Sent to ${device.name || device.device.name}:`, message);
            });
        }

        // Handle media upload
        function handleMediaUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            // Check if file is image or video
            const isImage = file.type.startsWith('image/');
            const isVideo = file.type.startsWith('video/');
            
            if (!isImage && !isVideo) {
                alert('Please select an image or video file');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const message = {
                    id: Date.now(),
                    sender: appState.currentUser,
                    text: isImage ? 'Sent an image' : 'Sent a video',
                    media: e.target.result,
                    timestamp: new Date().toISOString(),
                    type: isImage ? 'image' : 'video'
                };
                
                // In a real implementation, this would send via Bluetooth
                // For this demo, we'll just store it locally and simulate sending
                sendViaBluetooth(message);
                saveMessage(message);
                displayMessage(message);
                
                // Reset file input
                elements.mediaInput.value = '';
            };
            
            reader.readAsDataURL(file);
        }

        // Save message to localStorage
        function saveMessage(message) {
            const messages = JSON.parse(localStorage.getItem(STORAGE_KEYS.MESSAGES) || '[]');
            messages.push(message);
            localStorage.setItem(STORAGE_KEYS.MESSAGES, JSON.stringify(messages));
        }

        // Load messages from localStorage
        function loadMessages() {
            const messages = JSON.parse(localStorage.getItem(STORAGE_KEYS.MESSAGES) || '[]');
            elements.messagesContainer.innerHTML = '';
            
            messages.forEach(message => {
                displayMessage(message);
            });
        }

        // Display message in chat
        function displayMessage(message) {
            const messageEl = document.createElement('div');
            messageEl.classList.add('mb-4');
            
            const isOwnMessage = message.sender === appState.currentUser;
            
            if (message.type === 'text') {
                const decryptedText = isOwnMessage ? message.text : decryptMessage(message.text);
                
                messageEl.innerHTML = `
                    <div class="flex ${isOwnMessage ? 'justify-end' : 'justify-start'}">
                        <div class="chat-bubble-${isOwnMessage ? 'sent' : 'received'} bg-${isOwnMessage ? 'blue-500' : 'gray-200'} text-${isOwnMessage ? 'white' : 'gray-800'} px-4 py-2">
                            <p class="text-sm">${decryptedText}</p>
                            <span class="text-xs opacity-75 block mt-1">${formatTime(message.timestamp)} â€¢ ${message.sender}</span>
                        </div>
                    </div>
                `;
            } else if (message.type === 'image' || message.type === 'video') {
                messageEl.innerHTML = `
                    <div class="flex ${isOwnMessage ? 'justify-end' : 'justify-start'}">
                        <div class="max-w-xs">
                            <${message.type === 'image' ? 'img' : 'video'} 
                                src="${message.media}" 
                                class="rounded-lg max-w-full h-auto" 
                                ${message.type === 'video' ? 'controls' : ''}
                            >
                            <p class="text-sm mt-1 text-gray-600">${message.text}</p>
                            <span class="text-xs opacity-75 block mt-1">${formatTime(message.timestamp)} â€¢ ${message.sender}</span>
                        </div>
                    </div>
                `;
            }
            
            elements.messagesContainer.appendChild(messageEl);
            elements.messagesContainer.scrollTop = elements.messagesContainer.scrollHeight;
        }

        // Format timestamp
        function formatTime(timestamp) {
            const date = new Date(timestamp);
            return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        }

        // Simulate incoming message (for demo purposes)
        function simulateIncomingMessage(message) {
            // For demo purposes, we'll encrypt the message if it's text
            if (message.type === 'text') {
                message.text = encryptMessage(message.text);
            }
            
            saveMessage(message);
            displayMessage(message);
        }

        // Initialize the app when the DOM is loaded
        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>