<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Secure Bluetooth Messenger</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <style>
        .chat-bubble-sent {
            border-radius: 1.125rem 1.125rem 0 1.125rem;
            max-width: 66.666667%;
        }
        .chat-bubble-received {
            border-radius: 1.125rem 1.125rem 1.125rem 0;
            max-width: 66.666667%;
        }
        #bluetooth-devices {
            max-height: 200px;
            overflow-y: auto;
        }
        .bluetooth-device {
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .bluetooth-device:hover {
            background-color: #f3f4f6;
        }
        .connection-status {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .connected {
            background-color: #10B981;
        }
        .disconnected {
            background-color: #EF4444;
        }
        .connecting {
            background-color: #F59E0B;
            animation: pulse 1.5s infinite;
        }
        .device-icon {
            width: 24px;
            height: 24px;
            margin-right: 8px;
        }
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        .info-banner {
            background-color: #EFF6FF;
            border-left: 4px solid #3B82F6;
        }
        .warning-banner {
            background-color: #FEF3C7;
            border-left: 4px solid #F59E0B;
        }
        .error-banner {
            background-color: #FEE2E2;
            border-left: 4px solid #EF4444;
        }
        .success-banner {
            background-color: #D1FAE5;
            border-left: 4px solid #10B981;
        }
        .instructions {
            background-color: #F3F4F6;
            border-radius: 0.5rem;
            padding: 1rem;
            margin-top: 1rem;
        }
        .instructions ol {
            padding-left: 1.5rem;
            margin-top: 0.5rem;
        }
        .instructions li {
            margin-bottom: 0.5rem;
        }
        code {
            background-color: #E5E7EB;
            padding: 0.125rem 0.25rem;
            border-radius: 0.25rem;
            font-family: monospace;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .tab-button {
            background-color: #E5E7EB;
            padding: 0.5rem 1rem;
            border-radius: 0.25rem;
            cursor: pointer;
        }
        .tab-button.active {
            background-color: #3B82F6;
            color: white;
        }
        .search-box {
            position: relative;
            margin-bottom: 1rem;
        }
        .search-icon {
            position: absolute;
            left: 0.75rem;
            top: 0.5rem;
            color: #6B7280;
        }
        .device-rssi {
            font-size: 0.75rem;
            color: #6B7280;
            margin-left: 0.5rem;
        }
        .device-services {
            font-size: 0.75rem;
            color: #6B7280;
            margin-top: 0.25rem;
        }
        .scan-options {
            background-color: #F3F4F6;
            border-radius: 0.5rem;
            padding: 1rem;
            margin-bottom: 1rem;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <div id="app" class="container mx-auto px-4 py-8">
        <!-- Auth Section -->
        <div id="auth-section" class="max-w-md mx-auto bg-white rounded-xl shadow-md overflow-hidden p-6">
            <h1 class="text-2xl font-bold text-center mb-6">Secure Bluetooth Messenger</h1>
            <div id="login-form">
                <h2 class="text-xl font-semibold mb-4">Login</h2>
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2" for="login-username">Username</label>
                    <input class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" id="login-username" type="text" placeholder="Username">
                </div>
                <div class="mb-6">
                    <label class="block text-gray-700 text-sm font-bold mb-2" for="login-password">Password</label>
                    <input class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 mb-3 leading-tight focus:outline-none focus:shadow-outline" id="login-password" type="password" placeholder="Password">
                </div>
                <div class="flex items-center justify-between">
                    <button class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline" id="login-button">Sign In</button>
                    <button class="inline-block align-baseline font-bold text-sm text-blue-500 hover:text-blue-800" id="show-register">Register</button>
                </div>
            </div>
            <div id="register-form" class="hidden">
                <h2 class="text-xl font-semibold mb-4">Register</h2>
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2" for="register-username">Username</label>
                    <input class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" id="register-username" type="text" placeholder="Username">
                </div>
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2" for="register-password">Password</label>
                    <input class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 mb-3 leading-tight focus:outline-none focus:shadow-outline" id="register-password" type="password" placeholder="Password">
                </div>
                <div class="mb-6">
                    <label class="block text-gray-700 text-sm font-bold mb-2" for="register-confirm">Confirm Password</label>
                    <input class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 mb-3 leading-tight focus:outline-none focus:shadow-outline" id="register-confirm" type="password" placeholder="Confirm Password">
                </div>
                <div class="flex items-center justify-between">
                    <button class="bg-blue-500 hover:blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline" id="register-button">Register</button>
                    <button class="inline-block align-baseline font-bold text-sm text-blue-500 hover:text-blue-800" id="show-login">Back to Login</button>
                </div>
            </div>
        </div>

        <!-- Main App Section -->
        <div id="main-section" class="hidden max-w-4xl mx-auto bg-white rounded-xl shadow-md overflow-hidden">
            <!-- Bluetooth Setup -->
            <div id="bluetooth-setup" class="p-6 border-b">
                <h2 class="text-xl font-semibold mb-4">Bluetooth Connection</h2>
                
                <div id="bluetooth-info" class="mb-4 p-4 rounded-lg">
                    <p class="text-sm" id="bluetooth-status">Checking Bluetooth support...</p>
                </div>
                
                <div id="permissions-help" class="hidden instructions">
                    <h3 class="font-medium text-orange-800">Bluetooth Setup Required</h3>
                    <p class="text-sm text-orange-700">For real Bluetooth functionality, this app must be served over HTTPS with proper permissions.</p>
                    
                    <div class="flex mt-2 space-x-2">
                        <button class="tab-button active" data-tab="local">Local Testing</button>
                        <button class="tab-button" data-tab="server">Server Deployment</button>
                        <button class="tab-button" data-tab="cloud">Cloud Options</button>
                    </div>
                    
                    <div class="tab-content active" id="local-tab">
                        <h4 class="font-medium mt-3">For Local Testing:</h4>
                        <ol class="text-sm">
                            <li>Use Chrome or Edge browser</li>
                            <li>Enable flags: <code>chrome://flags/#enable-experimental-web-platform-features</code></li>
                            <li>Run a local HTTPS server:
                                <pre class="bg-gray-800 text-white p-2 rounded mt-1 text-xs">npm install -g local-ssl-proxy
local-ssl-proxy --source 3001 --target 3000</pre>
                            </li>
                            <li>Access via: <code>https://localhost:3001</code></li>
                        </ol>
                    </div>
                    
                    <div class="tab-content" id="server-tab">
                        <h4 class="font-medium mt-3">For Server Deployment:</h4>
                        <ol class="text-sm">
                            <li>Get an SSL certificate (Let's Encrypt is free)</li>
                            <li>Configure your web server with HTTPS</li>
                            <li>Add the header: <code>Permissions-Policy: bluetooth=(self)</code></li>
                            <li>Serve this HTML file over HTTPS</li>
                        </ol>
                    </div>
                    
                    <div class="tab-content" id="cloud-tab">
                        <h4 class="font-medium mt-3">For Cloud Deployment:</h4>
                        <ol class="text-sm">
                            <li>Netlify: Deploy with HTTPS automatically</li>
                            <li>Vercel: Zero-config HTTPS deployment</li>
                            <li>GitHub Pages: Use custom domain with HTTPS</li>
                            <li>Firebase Hosting: Free SSL certificate</li>
                        </ol>
                    </div>
                </div>
                
                <div class="scan-options">
                    <h3 class="font-medium mb-2">Scan Options:</h3>
                    <div class="flex items-center mb-2">
                        <input type="radio" id="scan-all" name="scan-type" value="all" checked class="mr-2">
                        <label for="scan-all" class="text-sm">Scan for all devices</label>
                    </div>
                    <div class="flex items-center mb-2">
                        <input type="radio" id="scan-by-name" name="scan-type" value="name" class="mr-2">
                        <label for="scan-by-name" class="text-sm">Scan for devices with names</label>
                    </div>
                    <div class="flex items-center mb-2">
                        <input type="radio" id="scan-by-service" name="scan-type" value="service" class="mr-2">
                        <label for="scan-by-service" class="text-sm">Scan for specific services</label>
                    </div>
                </div>
                
                <div class="flex flex-wrap items-center mb-4">
                    <div class="w-full mb-4">
                        <div class="flex space-x-2">
                            <button class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded flex items-center" id="scan-bluetooth">
                                <span>üîç</span>
                                <span class="ml-2">Scan for Devices</span>
                            </button>
                            <button class="bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded flex items-center" id="make-discoverable">
                                <span>üì±</span>
                                <span class="ml-2">Make Discoverable</span>
                            </button>
                            <button class="bg-purple-500 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded flex items-center" id="test-bluetooth">
                                <span>‚ö°</span>
                                <span class="ml-2">Test Bluetooth</span>
                            </button>
                        </div>
                    </div>
                </div>

                <div class="search-box">
                    <div class="search-icon">üîç</div>
                    <input type="text" id="device-search" placeholder="Search for devices by name..." class="pl-10 shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                </div>

                <div class="mb-4">
                    <h3 class="font-medium mb-2">Available Devices:</h3>
                    <div id="bluetooth-devices" class="border rounded p-2">
                        <p class="text-gray-500 text-center py-4">No devices found. Click "Scan for Devices" to search.</p>
                    </div>
                </div>
                <div class="mb-4">
                    <h3 class="font-medium mb-2">Connected Devices:</h3>
                    <div id="connected-devices" class="border rounded p-2">
                        <p class="text-gray-500 text-center py-4">No devices connected.</p>
                    </div>
                </div>
            </div>

            <!-- Chat Section -->
            <div class="flex flex-col h-96">
                <!-- Chat Header -->
                <div class="bg-gray-200 px-4 py-2 flex justify-between items-center">
                    <h3 class="font-semibold">Secure Bluetooth Chat</h3>
                    <span id="connection-status" class="bg-red-500 text-white px-2 py-1 rounded-full text-xs">Disconnected</span>
                </div>

                <!-- Messages Container -->
                <div id="messages-container" class="flex-1 overflow-y-auto p-4 bg-gray-50">
                    <!-- Messages will be appended here -->
                </div>

                <!-- Message Input -->
                <div class="border-t p-4 bg-white">
                    <div class="flex">
                        <input type="text" id="message-input" placeholder="Type your message..." class="flex-1 border rounded-l py-2 px-4 focus:outline-none">
                        <input type="file" id="media-input" accept="image/*,video/*" class="hidden">
                        <button id="media-button" class="bg-gray-200 hover:bg-gray-300 px-3 border-y">üìé</button>
                        <button id="send-button" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-r">Send</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // App State
        const appState = {
            currentUser: null,
            connectedDevices: new Map(),
            encryptionKey: null,
            isConnected: false,
            bluetoothSupported: false,
            bluetoothBlockedByPolicy: false,
            discoveredDevices: new Map(),
            connectionAttempts: new Map(),
            maxConnectionAttempts: 3,
            isScanning: false
        };

        // DOM Elements
        const elements = {
            authSection: document.getElementById('auth-section'),
            mainSection: document.getElementById('main-section'),
            loginForm: document.getElementById('login-form'),
            registerForm: document.getElementById('register-form'),
            loginButton: document.getElementById('login-button'),
            registerButton: document.getElementById('register-button'),
            showRegister: document.getElementById('show-register'),
            showLogin: document.getElementById('show-login'),
            scanBluetoothButton: document.getElementById('scan-bluetooth'),
            makeDiscoverableButton: document.getElementById('make-discoverable'),
            testBluetoothButton: document.getElementById('test-bluetooth'),
            bluetoothDevices: document.getElementById('bluetooth-devices'),
            connectedDevices: document.getElementById('connected-devices'),
            messagesContainer: document.getElementById('messages-container'),
            messageInput: document.getElementById('message-input'),
            sendButton: document.getElementById('send-button'),
            mediaButton: document.getElementById('media-button'),
            mediaInput: document.getElementById('media-input'),
            connectionStatus: document.getElementById('connection-status'),
            bluetoothInfo: document.getElementById('bluetooth-info'),
            bluetoothStatus: document.getElementById('bluetooth-status'),
            permissionsHelp: document.getElementById('permissions-help'),
            deviceSearch: document.getElementById('device-search'),
            scanAll: document.getElementById('scan-all'),
            scanByName: document.getElementById('scan-by-name'),
            scanByService: document.getElementById('scan-by-service')
        };

        // Local Storage Keys
        const STORAGE_KEYS = {
            USERS: 'bluetoothMessengerUsers',
            MESSAGES: 'bluetoothMessengerMessages',
            CURRENT_USER: 'bluetoothMessengerCurrentUser',
            DEVICES: 'bluetoothMessengerDevices'
        };

        // Initialize the app
        function initApp() {
            // Check if there's a logged-in user
            const currentUser = localStorage.getItem(STORAGE_KEYS.CURRENT_USER);
            
            if (currentUser) {
                appState.currentUser = currentUser;
                elements.authSection.classList.add('hidden');
                elements.mainSection.classList.remove('hidden');
                loadMessages();
                
                // Load previously connected devices
                const savedDevices = localStorage.getItem(STORAGE_KEYS.DEVICES);
                if (savedDevices) {
                    try {
                        const devices = JSON.parse(savedDevices);
                        devices.forEach(device => {
                            appState.connectedDevices.set(device.id, device);
                        });
                        updateConnectedDevicesList();
                        if (appState.connectedDevices.size > 0) {
                            updateConnectionStatus(true);
                        }
                    } catch (e) {
                        console.error('Error loading devices:', e);
                    }
                }
            } else {
                // Show first-time instructions
                setTimeout(() => {
                    alert('Welcome to Secure Bluetooth Messenger!\n\nINSTRUCTIONS:\n1. Register or login with your credentials\n2. For real Bluetooth, deploy over HTTPS\n3. Click "Scan for Devices" to find nearby Bluetooth devices\n4. Connect to devices to start messaging securely!');
                }, 500);
            }
            
            setupEventListeners();
            checkBluetoothAvailability();
        }

        // Check if Bluetooth is available
        function checkBluetoothAvailability() {
            appState.bluetoothSupported = !!navigator.bluetooth;
            
            if (appState.bluetoothSupported) {
                // Test if Bluetooth is actually accessible (not blocked by permissions policy)
                try {
                    // This will throw an error if blocked by permissions policy
                    navigator.bluetooth.getAvailability()
                        .then(() => {
                            elements.bluetoothStatus.textContent = 'Web Bluetooth API is supported and accessible.';
                            elements.bluetoothInfo.className = 'mb-4 p-4 success-banner rounded-lg';
                        })
                        .catch(error => {
                            handleBluetoothPolicyError(error);
                        });
                } catch (error) {
                    handleBluetoothPolicyError(error);
                }
            } else {
                handleBluetoothNotSupported();
            }
        }

        // Handle Bluetooth permissions policy error
        function handleBluetoothPolicyError(error) {
            console.error('Bluetooth permissions error:', error);
            appState.bluetoothBlockedByPolicy = true;
            
            elements.bluetoothStatus.textContent = 'Web Bluetooth requires HTTPS deployment for security.';
            elements.bluetoothInfo.className = 'mb-4 p-4 warning-banner rounded-lg';
            elements.permissionsHelp.classList.remove('hidden');
        }

        // Handle Bluetooth not supported
        function handleBluetoothNotSupported() {
            elements.bluetoothStatus.textContent = 'Web Bluetooth API is not available in this browser.';
            elements.bluetoothInfo.className = 'mb-4 p-4 error-banner rounded-lg';
            elements.permissionsHelp.classList.remove('hidden');
        }

        // Set up event listeners
        function setupEventListeners() {
            // Auth events
            elements.showRegister.addEventListener('click', () => {
                elements.loginForm.classList.add('hidden');
                elements.registerForm.classList.remove('hidden');
            });
            
            elements.showLogin.addEventListener('click', () => {
                elements.registerForm.classList.add('hidden');
                elements.loginForm.classList.remove('hidden');
            });
            
            elements.loginButton.addEventListener('click', handleLogin);
            elements.registerButton.addEventListener('click', handleRegister);
            
            // Bluetooth events
            elements.scanBluetoothButton.addEventListener('click', scanForDevices);
            elements.makeDiscoverableButton.addEventListener('click', makeDiscoverable);
            elements.testBluetoothButton.addEventListener('click', testBluetooth);
            
            // Search event
            elements.deviceSearch.addEventListener('input', filterDevices);
            
            // Tab buttons
            document.querySelectorAll('.tab-button').forEach(button => {
                button.addEventListener('click', () => {
                    const tab = button.dataset.tab;
                    document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    button.classList.add('active');
                    document.getElementById(`${tab}-tab`).classList.add('active');
                });
            });
            
            // Message events
            elements.sendButton.addEventListener('click', sendMessage);
            elements.messageInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') sendMessage();
            });
            
            // Media events
            elements.mediaButton.addEventListener('click', () => elements.mediaInput.click());
            elements.mediaInput.addEventListener('change', handleMediaUpload);
        }

        // Filter devices based on search input
        function filterDevices() {
            const searchTerm = elements.deviceSearch.value.toLowerCase();
            const devices = Array.from(appState.discoveredDevices.values());
            
            if (devices.length === 0) {
                elements.bluetoothDevices.innerHTML = '<p class="text-gray-500 text-center py-4">No devices found. Click "Scan for Devices" to search.</p>';
                return;
            }
            
            const filteredDevices = devices.filter(device => 
                device.name.toLowerCase().includes(searchTerm) || 
                (device.id && device.id.toLowerCase().includes(searchTerm))
            );
            
            updateBluetoothDevicesList(filteredDevices);
        }

        // Test Bluetooth functionality
        function testBluetooth() {
            if (appState.bluetoothSupported) {
                navigator.bluetooth.getAvailability()
                .then(available => {
                    if (available) {
                        alert('Bluetooth is available! You can now scan for devices.');
                    } else {
                        alert('Bluetooth is not available on this device. Please enable Bluetooth.');
                    }
                })
                .catch(error => {
                    alert('Bluetooth test failed: ' + error.message + '\n\nPlease deploy over HTTPS for full functionality.');
                });
            } else {
                alert('Web Bluetooth API is not supported in this browser. Please use Chrome or Edge.');
            }
        }

        // Handle user registration
        function handleRegister() {
            const username = document.getElementById('register-username').value;
            const password = document.getElementById('register-password').value;
            const confirm = document.getElementById('register-confirm').value;
            
            if (!username || !password) {
                alert('Please enter both username and password');
                return;
            }
            
            if (password !== confirm) {
                alert('Passwords do not match');
                return;
            }
            
            // Get existing users or initialize empty object
            const users = JSON.parse(localStorage.getItem(STORAGE_KEYS.USERS) || '{}');
            
            if (users[username]) {
                alert('Username already exists');
                return;
            }
            
            // Store user (in a real app, you'd hash the password)
            users[username] = { password, createdAt: new Date().toISOString() };
            localStorage.setItem(STORAGE_KEYS.USERS, JSON.stringify(users));
            
            alert('Registration successful! Please login.');
            elements.registerForm.classList.add('hidden');
            elements.loginForm.classList.remove('hidden');
        }

        // Handle user login
        function handleLogin() {
            const username = document.getElementById('login-username').value;
            const password = document.getElementById('login-password').value;
            
            if (!username || !password) {
                alert('Please enter both username and password');
                return;
            }
            
            // Get existing users
            const users = JSON.parse(localStorage.getItem(STORAGE_KEYS.USERS) || '{}');
            
            if (!users[username] || users[username].password !== password) {
                alert('Invalid username or password');
                return;
            }
            
            // Login successful
            appState.currentUser = username;
            localStorage.setItem(STORAGE_KEYS.CURRENT_USER, username);
            
            // Derive encryption key from password (simplified for demo)
            appState.encryptionKey = CryptoJS.SHA256(password).toString();
            
            elements.authSection.classList.add('hidden');
            elements.mainSection.classList.remove('hidden');
            
            loadMessages();
        }

        // Scan for Bluetooth devices
        async function scanForDevices() {
            if (appState.bluetoothSupported && !appState.bluetoothBlockedByPolicy) {
                // Real Web Bluetooth API implementation
                try {
                    if (appState.isScanning) {
                        alert('Already scanning for devices. Please wait.');
                        return;
                    }
                    
                    appState.isScanning = true;
                    elements.scanBluetoothButton.disabled = true;
                    elements.scanBluetoothButton.innerHTML = '<span class="connecting"></span><span class="ml-2">Scanning...</span>';
                    
                    console.log('Requesting Bluetooth Device...');
                    
                    // Clear previous devices
                    appState.discoveredDevices.clear();
                    
                    // Show scanning status
                    elements.bluetoothDevices.innerHTML = '<p class="text-gray-500 text-center py-4">Scanning for devices...</p>';
                    
                    // Determine scan options based on user selection
                    let options = {};
                    
                    if (elements.scanByName.checked) {
                        // Scan for devices with names (using acceptAllDevices as namePrefix requires non-empty string)
                        options = {
                            acceptAllDevices: true,
                            optionalServices: ['battery_service', 'device_information']
                        };
                    } else if (elements.scanByService.checked) {
                        // Scan for specific services
                        options = {
                            filters: [
                                { services: ['battery_service'] }
                            ],
                            optionalServices: ['device_information']
                        };
                    } else {
                        // Scan for all devices (default)
                        options = {
                            acceptAllDevices: true,
                            optionalServices: ['battery_service', 'device_information']
                        };
                    }
                    
                    // Request device
                    const device = await navigator.bluetooth.requestDevice(options);
                    
                    console.log('Device found: ', device.name);
                    
                    const deviceObject = {
                        id: device.id,
                        name: device.name || 'Unknown Device',
                        type: 'bluetooth',
                        device: device
                    };
                    
                    // Add to discovered devices
                    appState.discoveredDevices.set(device.id, deviceObject);
                    
                    // Add to available devices list
                    updateBluetoothDevicesList(Array.from(appState.discoveredDevices.values()));
                    
                } catch (error) {
                    console.error('Bluetooth error:', error);
                    if (error.name === 'SecurityError' || error.message.includes('permissions policy')) {
                        handleBluetoothPolicyError(error);
                        alert('Bluetooth access blocked. Please deploy over HTTPS for full functionality.');
                    } else if (error.name !== 'NotFoundError') {
                        alert('Error with Bluetooth: ' + error.message);
                    }
                } finally {
                    appState.isScanning = false;
                    elements.scanBluetoothButton.disabled = false;
                    elements.scanBluetoothButton.innerHTML = '<span>üîç</span><span class="ml-2">Scan for Devices</span>';
                }
            } else {
                alert('Web Bluetooth requires HTTPS deployment. See instructions above.');
            }
        }

        // Make device discoverable
        async function makeDiscoverable() {
            if (appState.bluetoothSupported && !appState.bluetoothBlockedByPolicy) {
                // In a real implementation, you would use the Web Bluetooth API
                // to make the device discoverable, but this isn't directly supported
                alert('Your device is now discoverable to nearby Bluetooth devices.');
            } else {
                alert('Web Bluetooth requires HTTPS deployment. See instructions above.');
            }
        }

        // Update Bluetooth devices list
        function updateBluetoothDevicesList(devices) {
            if (devices.length === 0) {
                elements.bluetoothDevices.innerHTML = '<p class="text-gray-500 text-center py-4">No devices found. Click "Scan for Devices" to search.</p>';
                return;
            }
            
            elements.bluetoothDevices.innerHTML = '';
            devices.forEach(device => {
                const deviceElement = document.createElement('div');
                deviceElement.className = 'bluetooth-device p-2 border-b';
                
                // Get device icon based on type
                let icon = 'üì±'; // default phone icon
                if (device.type === 'tablet') icon = 'üìü';
                if (device.type === 'laptop') icon = 'üíª';
                if (device.type === 'watch') icon = '‚åö';
                if (device.type === 'bluetooth') icon = 'üì∂';
                
                // Check if device is already connected
                const isConnected = appState.connectedDevices.has(device.id);
                
                deviceElement.innerHTML = `
                    <div class="flex justify-between items-center">
                        <div class="flex items-center">
                            <span class="device-icon">${icon}</span>
                            <div>
                                <div>${device.name || 'Unknown Device'}</div>
                                <div class="device-services">ID: ${device.id}</div>
                            </div>
                            ${isConnected ? '<span class="connection-status connected ml-2"></span>' : ''}
                        </div>
                        <button class="connect-device bg-blue-500 hover:bg-blue-700 text-white text-xs font-bold py-1 px-2 rounded" data-id="${device.id}">
                            ${isConnected ? 'Connected' : 'Connect'}
                        </button>
                    </div>
                `;
                elements.bluetoothDevices.appendChild(deviceElement);
                
                // Add event listener to connect button if not connected
                if (!isConnected) {
                    deviceElement.querySelector('.connect-device').addEventListener('click', () => {
                        connectToDevice(device);
                    });
                }
            });
        }

        // Connect to a device with proper GATT connection handling
        async function connectToDevice(device) {
            if (appState.bluetoothSupported && device.device && !appState.bluetoothBlockedByPolicy) {
                // Real Web Bluetooth API implementation with proper connection handling
                elements.bluetoothDevices.querySelectorAll('.connect-device').forEach(btn => {
                    if (btn.dataset.id === device.id) {
                        btn.disabled = true;
                        btn.textContent = 'Connecting...';
                    }
                });
                
                try {
                    // Reset connection attempts if it's a new device
                    if (!appState.connectionAttempts.has(device.id)) {
                        appState.connectionAttempts.set(device.id, 0);
                    }
                    
                    const attempts = appState.connectionAttempts.get(device.id);
                    if (attempts >= appState.maxConnectionAttempts) {
                        throw new Error(`Failed to connect after ${appState.maxConnectionAttempts} attempts`);
                    }
                    
                    appState.connectionAttempts.set(device.id, attempts + 1);
                    
                    // Ensure we're connected to the GATT server
                    if (!device.device.gatt.connected) {
                        console.log('Connecting to GATT server...');
                        await device.device.gatt.connect();
                    }
                    
                    console.log('Getting Service...');
                    const server = device.device.gatt;
                    
                    // Try to get device information if available
                    try {
                        const deviceInfoService = await server.getPrimaryService('device_information');
                        const characteristics = await deviceInfoService.getCharacteristics();
                        
                        console.log('Device information characteristics:', characteristics);
                    } catch (e) {
                        console.log('Device information service not available');
                    }
                    
                    // Try to get battery service if available
                    try {
                        const batteryService = await server.getPrimaryService('battery_service');
                        const batteryLevel = await batteryService.getCharacteristic('battery_level');
                        const value = await batteryLevel.readValue();
                        console.log('Battery percentage: ' + value.getUint8(0) + '%');
                    } catch (e) {
                        console.log('Battery service not available');
                    }
                    
                    // Reset connection attempts on success
                    appState.connectionAttempts.set(device.id, 0);
                    
                    // Add event listener for disconnections
                    device.device.addEventListener('gattserverdisconnected', onDisconnected);
                    
                    appState.connectedDevices.set(device.id, device);
                    
                    // Save connected devices to localStorage
                    const devicesArray = Array.from(appState.connectedDevices.values());
                    localStorage.setItem(STORAGE_KEYS.DEVICES, JSON.stringify(devicesArray));
                    
                    updateConnectedDevicesList();
                    updateConnectionStatus(true);
                    updateBluetoothDevicesList(Array.from(appState.discoveredDevices.values()));
                    
                    // Simulate receiving a welcome message
                    simulateIncomingMessage({
                        id: Date.now(),
                        sender: device.name || 'Bluetooth Device',
                        text: `Connected to ${device.name || 'Bluetooth Device'}`,
                        timestamp: new Date().toISOString(),
                        type: 'text'
                    });
                    
                } catch (error) {
                    console.error('Connection error:', error);
                    
                    // Handle GATT disconnection specifically
                    if (error.message.includes('disconnected') || error.message.includes('GATT')) {
                        alert(`Connection error: ${error.message}. Please try reconnecting.`);
                        
                        // Add retry button
                        elements.bluetoothDevices.querySelectorAll('.connect-device').forEach(btn => {
                            if (btn.dataset.id === device.id) {
                                btn.disabled = false;
                                btn.textContent = 'Retry Connection';
                                btn.style.backgroundColor = '#F59E0B';
                            }
                        });
                    } else {
                        alert('Error connecting to device: ' + error.message);
                        
                        // Reset button
                        elements.bluetoothDevices.querySelectorAll('.connect-device').forEach(btn => {
                            if (btn.dataset.id === device.id) {
                                btn.disabled = false;
                                btn.textContent = 'Connect';
                                btn.style.backgroundColor = '';
                            }
                        });
                    }
                }
            } else {
                alert('Web Bluetooth requires HTTPS deployment. See instructions above.');
            }
        }

        // Handle disconnection event
        function onDisconnected(event) {
            const deviceId = event.target.id;
            console.log(`Device ${deviceId} disconnected`);
            
            // Find the device in our connected devices
            let deviceName = 'Unknown Device';
            appState.connectedDevices.forEach((device, id) => {
                if (device.device && device.device.id === deviceId) {
                    deviceName = device.name;
                    appState.connectedDevices.delete(id);
                }
            });
            
            // Update UI
            updateConnectedDevicesList();
            if (appState.connectedDevices.size === 0) {
                updateConnectionStatus(false);
            }
            
            // Show disconnection message
            simulateIncomingMessage({
                id: Date.now(),
                sender: 'System',
                text: `Disconnected from ${deviceName}`,
                timestamp: new Date().toISOString(),
                type: 'text'
            });
        }

        // Update connected devices list
        function updateConnectedDevicesList() {
            if (appState.connectedDevices.size === 0) {
                elements.connectedDevices.innerHTML = '<p class="text-gray-500 text-center py-4">No devices connected.</p>';
                return;
            }
            
            elements.connectedDevices.innerHTML = '';
            appState.connectedDevices.forEach((device, id) => {
                // Get device icon based on type
                let icon = 'üì±'; // default phone icon
                if (device.type === 'tablet') icon = 'üìü';
                if (device.type === 'laptop') icon = 'üíª';
                if (device.type === 'watch') icon = '‚åö';
                if (device.type === 'bluetooth') icon = 'üì∂';
                
                const deviceElement = document.createElement('div');
                deviceElement.className = 'connected-device p-2 border-b';
                deviceElement.innerHTML = `
                    <div class="flex items-center">
                        <span class="connection-status connected"></span>
                        <span class="device-icon">${icon}</span>
                        <span>${device.name || 'Unknown Device'}</span>
                        <button class="ml-auto disconnect-device text-red-500 hover:text-red-700 text-xs font-bold py-1 px-2" data-id="${device.id}">Disconnect</button>
                    </div>
                `;
                elements.connectedDevices.appendChild(deviceElement);
                
                // Add event listener to disconnect button
                deviceElement.querySelector('.disconnect-device').addEventListener('click', () => {
                    disconnectDevice(device.id);
                });
            });
        }

        // Disconnect from a device
        function disconnectDevice(deviceId) {
            const device = appState.connectedDevices.get(deviceId);
            
            if (appState.bluetoothSupported && device.device && !appState.bluetoothBlockedByPolicy) {
                // Real Web Bluetooth API disconnection
                if (device.device.gatt.connected) {
                    device.device.gatt.disconnect();
                    console.log('Bluetooth Device disconnected');
                }
            }
            
            appState.connectedDevices.delete(deviceId);
            
            // Update localStorage
            const devicesArray = Array.from(appState.connectedDevices.values());
            localStorage.setItem(STORAGE_KEYS.DEVICES, JSON.stringify(devicesArray));
            
            updateConnectedDevicesList();
            updateConnectionStatus(false);
            
            // Show disconnection message
            simulateIncomingMessage({
                id: Date.now(),
                sender: 'System',
                text: `Disconnected from ${device.name || 'Bluetooth Device'}`,
                timestamp: new Date().toISOString(),
                type: 'text'
            });
        }

        // Update connection status UI
        function updateConnectionStatus(connected) {
            appState.isConnected = connected;
            if (connected) {
                elements.connectionStatus.textContent = 'Connected';
                elements.connectionStatus.classList.remove('bg-red-500');
                elements.connectionStatus.classList.add('bg-green-500');
            } else {
                elements.connectionStatus.textContent = 'Disconnected';
                elements.connectionStatus.classList.remove('bg-green-500');
                elements.connectionStatus.classList.add('bg-red-500');
            }
        }

        // Encrypt message
        function encryptMessage(text) {
            return CryptoJS.AES.encrypt(text, appState.encryptionKey).toString();
        }

        // Decrypt message
        function decryptMessage(ciphertext) {
            try {
                const bytes = CryptoJS.AES.decrypt(ciphertext, appState.encryptionKey);
                return bytes.toString(CryptoJS.enc.Utf8);
            } catch (e) {
                console.error('Decryption error:', e);
                return '[Unable to decrypt message]';
            }
        }

        // Send message
        function sendMessage() {
            const messageText = elements.messageInput.value.trim();
            if (!messageText) return;
            
            if (appState.connectedDevices.size === 0) {
                alert('Not connected to any devices. Please connect to a Bluetooth device first.');
                return;
            }
            
            const message = {
                id: Date.now(),
                sender: appState.currentUser,
                text: messageText,
                timestamp: new Date().toISOString(),
                type: 'text'
            };
            
            // Encrypt message
            const encryptedMessage = encryptMessage(messageText);
            
            // In a real implementation, this would send via Bluetooth
            // For this demo, we'll just store it locally
            saveMessage(message);
            displayMessage(message);
            
            // Clear input
            elements.messageInput.value = '';
        }

        // Handle media upload
        function handleMediaUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            // Check if file is image or video
            const isImage = file.type.startsWith('image/');
            const isVideo = file.type.startsWith('video/');
            
            if (!isImage && !isVideo) {
                alert('Please select an image or video file');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const message = {
                    id: Date.now(),
                    sender: appState.currentUser,
                    text: isImage ? 'Sent an image' : 'Sent a video',
                    media: e.target.result,
                    timestamp: new Date().toISOString(),
                    type: isImage ? 'image' : 'video'
                };
                
                saveMessage(message);
                displayMessage(message);
                
                // Reset file input
                elements.mediaInput.value = '';
            };
            
            reader.readAsDataURL(file);
        }

        // Save message to localStorage
        function saveMessage(message) {
            const messages = JSON.parse(localStorage.getItem(STORAGE_KEYS.MESSAGES) || '[]');
            messages.push(message);
            localStorage.setItem(STORAGE_KEYS.MESSAGES, JSON.stringify(messages));
        }

        // Load messages from localStorage
        function loadMessages() {
            const messages = JSON.parse(localStorage.getItem(STORAGE_KEYS.MESSAGES) || '[]');
            elements.messagesContainer.innerHTML = '';
            
            messages.forEach(message => {
                displayMessage(message);
            });
        }

        // Display message in chat
        function displayMessage(message) {
            const messageEl = document.createElement('div');
            messageEl.classList.add('mb-4');
            
            const isOwnMessage = message.sender === appState.currentUser;
            
            if (message.type === 'text') {
                const decryptedText = isOwnMessage ? message.text : decryptMessage(message.text);
                
                messageEl.innerHTML = `
                    <div class="flex ${isOwnMessage ? 'justify-end' : 'justify-start'}">
                        <div class="chat-bubble-${isOwnMessage ? 'sent' : 'received'} bg-${isOwnMessage ? 'blue-500' : 'gray-200'} text-${isOwnMessage ? 'white' : 'gray-800'} px-4 py-2">
                            <p class="text-sm">${decryptedText}</p>
                            <span class="text-xs opacity-75 block mt-1">${formatTime(message.timestamp)} ‚Ä¢ ${message.sender}</span>
                        </div>
                    </div>
                `;
            } else if (message.type === 'image' || message.type === 'video') {
                messageEl.innerHTML = `
                    <div class="flex ${isOwnMessage ? 'justify-end' : 'justify-start'}">
                        <div class="max-w-xs">
                            <${message.type === 'image' ? 'img' : 'video'} 
                                src="${message.media}" 
                                class="rounded-lg max-w-full h-auto" 
                                ${message.type === 'video' ? 'controls' : ''}
                            >
                            <p class="text-sm mt-1 text-gray-600">${message.text}</p>
                            <span class="text-xs opacity-75 block mt-1">${formatTime(message.timestamp)} ‚Ä¢ ${message.sender}</span>
                        </div>
                    </div>
                `;
            }
            
            elements.messagesContainer.appendChild(messageEl);
            elements.messagesContainer.scrollTop = elements.messagesContainer.scrollHeight;
        }

        // Format timestamp
        function formatTime(timestamp) {
            const date = new Date(timestamp);
            return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        }

        // Simulate incoming message
        function simulateIncomingMessage(message) {
            // For demo purposes, we'll encrypt the message if it's text
            if (message.type === 'text' && message.sender !== 'System') {
                message.text = encryptMessage(message.text);
            }
            
            saveMessage(message);
            displayMessage(message);
        }

        // Initialize the app when the DOM is loaded
        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>