<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bluetooth Web Messenger</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <style>
        .chat-bubble-sent {
            border-radius: 1.125rem 1.125rem 0 1.125rem;
            max-width: 66.666667%;
        }
        .chat-bubble-received {
            border-radius: 1.125rem 1.125rem 1.125rem 0;
            max-width: 66.666667%;
        }
        #bluetooth-devices {
            max-height: 200px;
            overflow-y: auto;
        }
        .bluetooth-device {
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .bluetooth-device:hover {
            background-color: #f3f4f6;
        }
        .connection-status {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .connected {
            background-color: #10B981;
        }
        .disconnected {
            background-color: #EF4444;
        }
        .connecting {
            background-color: #F59E0B;
            animation: pulse 1.5s infinite;
        }
        .device-icon {
            width: 24px;
            height: 24px;
            margin-right: 8px;
        }
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        .info-banner {
            background-color: #EFF6FF;
            border-left: 4px solid #3B82F6;
        }
        .simulated-badge {
            background-color: #F59E0B;
            color: white;
            font-size: 0.75rem;
            padding: 0.125rem 0.5rem;
            border-radius: 0.25rem;
            margin-left: 0.5rem;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <div id="app" class="container mx-auto px-4 py-8">
        <!-- Auth Section -->
        <div id="auth-section" class="max-w-md mx-auto bg-white rounded-xl shadow-md overflow-hidden p-6">
            <h1 class="text-2xl font-bold text-center mb-6">Bluetooth Messenger</h1>
            <div id="login-form">
                <h2 class="text-xl font-semibold mb-4">Login</h2>
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2" for="login-username">Username</label>
                    <input class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" id="login-username" type="text" placeholder="Username">
                </div>
                <div class="mb-6">
                    <label class="block text-gray-700 text-sm font-bold mb-2" for="login-password">Password</label>
                    <input class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 mb-3 leading-tight focus:outline-none focus:shadow-outline" id="login-password" type="password" placeholder="Password">
                </div>
                <div class="flex items-center justify-between">
                    <button class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline" id="login-button">Sign In</button>
                    <button class="inline-block align-baseline font-bold text-sm text-blue-500 hover:text-blue-800" id="show-register">Register</button>
                </div>
            </div>
            <div id="register-form" class="hidden">
                <h2 class="text-xl font-semibold mb-4">Register</h2>
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2" for="register-username">Username</label>
                    <input class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" id="register-username" type="text" placeholder="Username">
                </div>
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2" for="register-password">Password</label>
                    <input class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 mb-3 leading-tight focus:outline-none focus:shadow-outline" id="register-password" type="password" placeholder="Password">
                </div>
                <div class="mb-6">
                    <label class="block text-gray-700 text-sm font-bold mb-2" for="register-confirm">Confirm Password</label>
                    <input class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 mb-3 leading-tight focus:outline-none focus:shadow-outline" id="register-confirm" type="password" placeholder="Confirm Password">
                </div>
                <div class="flex items-center justify-between">
                    <button class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline" id="register-button">Register</button>
                    <button class="inline-block align-baseline font-bold text-sm text-blue-500 hover:text-blue-800" id="show-login">Back to Login</button>
                </div>
            </div>
        </div>

        <!-- Main App Section -->
        <div id="main-section" class="hidden max-w-4xl mx-auto bg-white rounded-xl shadow-md overflow-hidden">
            <!-- Bluetooth Setup -->
            <div id="bluetooth-setup" class="p-6 border-b">
                <h2 class="text-xl font-semibold mb-4">Bluetooth Connection</h2>
                
                <div id="bluetooth-info" class="mb-4 p-4 info-banner rounded-lg">
                    <p class="text-blue-700 text-sm" id="bluetooth-status">Checking Bluetooth support...</p>
                </div>
                
                <div class="flex flex-wrap items-center mb-4">
                    <div class="w-full mb-4">
                        <div class="flex space-x-2">
                            <button class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded flex items-center" id="scan-bluetooth">
                                <span>üîç</span>
                                <span class="ml-2">Scan for Devices</span>
                            </button>
                            <button class="bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded flex items-center" id="make-discoverable">
                                <span>üì±</span>
                                <span class="ml-2">Make Discoverable</span>
                            </button>
                        </div>
                    </div>
                </div>
                <div class="mb-4">
                    <h3 class="font-medium mb-2">Available Devices:</h3>
                    <div id="bluetooth-devices" class="border rounded p-2">
                        <p class="text-gray-500 text-center py-4">No devices found. Click "Scan for Devices" to search.</p>
                    </div>
                </div>
                <div class="mb-4">
                    <h3 class="font-medium mb-2">Connected Devices:</h3>
                    <div id="connected-devices" class="border rounded p-2">
                        <p class="text-gray-500 text-center py-4">No devices connected.</p>
                    </div>
                </div>
            </div>

            <!-- Chat Section -->
            <div class="flex flex-col h-96">
                <!-- Chat Header -->
                <div class="bg-gray-200 px-4 py-2 flex justify-between items-center">
                    <h3 class="font-semibold">Bluetooth Chat</h3>
                    <span id="connection-status" class="bg-red-500 text-white px-2 py-1 rounded-full text-xs">Disconnected</span>
                </div>

                <!-- Messages Container -->
                <div id="messages-container" class="flex-1 overflow-y-auto p-4 bg-gray-50">
                    <!-- Messages will be appended here -->
                </div>

                <!-- Message Input -->
                <div class="border-t p-4 bg-white">
                    <div class="flex">
                        <input type="text" id="message-input" placeholder="Type your message..." class="flex-1 border rounded-l py-2 px-4 focus:outline-none">
                        <input type="file" id="media-input" accept="image/*,video/*" class="hidden">
                        <button id="media-button" class="bg-gray-200 hover:bg-gray-300 px-3 border-y">üìé</button>
                        <button id="send-button" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-r">Send</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // App State
        const appState = {
            currentUser: null,
            connectedDevices: new Map(),
            encryptionKey: null,
            isConnected: false,
            bluetoothSupported: false,
            usingSimulation: false,
            simulatedDevices: [
                { id: 'device-1', name: 'Phone User', type: 'phone' },
                { id: 'device-2', name: 'Tablet User', type: 'tablet' },
                { id: 'device-3', name: 'Laptop User', type: 'laptop' },
                { id: 'device-4', name: 'Smartwatch', type: 'watch' }
            ]
        };

        // DOM Elements
        const elements = {
            authSection: document.getElementById('auth-section'),
            mainSection: document.getElementById('main-section'),
            loginForm: document.getElementById('login-form'),
            registerForm: document.getElementById('register-form'),
            loginButton: document.getElementById('login-button'),
            registerButton: document.getElementById('register-button'),
            showRegister: document.getElementById('show-register'),
            showLogin: document.getElementById('show-login'),
            scanBluetoothButton: document.getElementById('scan-bluetooth'),
            makeDiscoverableButton: document.getElementById('make-discoverable'),
            bluetoothDevices: document.getElementById('bluetooth-devices'),
            connectedDevices: document.getElementById('connected-devices'),
            messagesContainer: document.getElementById('messages-container'),
            messageInput: document.getElementById('message-input'),
            sendButton: document.getElementById('send-button'),
            mediaButton: document.getElementById('media-button'),
            mediaInput: document.getElementById('media-input'),
            connectionStatus: document.getElementById('connection-status'),
            bluetoothInfo: document.getElementById('bluetooth-info'),
            bluetoothStatus: document.getElementById('bluetooth-status')
        };

        // Local Storage Keys
        const STORAGE_KEYS = {
            USERS: 'bluetoothMessengerUsers',
            MESSAGES: 'bluetoothMessengerMessages',
            CURRENT_USER: 'bluetoothMessengerCurrentUser',
            DEVICES: 'bluetoothMessengerDevices'
        };

        // Initialize the app
        function initApp() {
            // Check if there's a logged-in user
            const currentUser = localStorage.getItem(STORAGE_KEYS.CURRENT_USER);
            
            if (currentUser) {
                appState.currentUser = currentUser;
                elements.authSection.classList.add('hidden');
                elements.mainSection.classList.remove('hidden');
                loadMessages();
                
                // Load previously connected devices
                const savedDevices = localStorage.getItem(STORAGE_KEYS.DEVICES);
                if (savedDevices) {
                    try {
                        const devices = JSON.parse(savedDevices);
                        devices.forEach(device => {
                            appState.connectedDevices.set(device.id, device);
                        });
                        updateConnectedDevicesList();
                        if (appState.connectedDevices.size > 0) {
                            updateConnectionStatus(true);
                        }
                    } catch (e) {
                        console.error('Error loading devices:', e);
                    }
                }
            } else {
                // Show first-time instructions
                setTimeout(() => {
                    alert('Welcome to Bluetooth Web Messenger!\n\nINSTRUCTIONS:\n1. Register or login with your credentials\n2. Click "Scan for Devices" to find nearby Bluetooth devices\n3. Click "Make Discoverable" to allow others to find your device\n4. Connect to devices to start messaging securely!');
                }, 500);
            }
            
            setupEventListeners();
            checkBluetoothAvailability();
        }

        // Check if Bluetooth is available
        function checkBluetoothAvailability() {
            appState.bluetoothSupported = !!navigator.bluetooth;
            
            if (appState.bluetoothSupported) {
                elements.bluetoothStatus.textContent = 'Web Bluetooth API is supported in your browser.';
                elements.bluetoothInfo.className = 'mb-4 p-4 bg-green-50 border-l-4 border-green-500 rounded-lg';
            } else {
                appState.usingSimulation = true;
                elements.bluetoothStatus.textContent = 'Web Bluetooth API is not available. Using simulated Bluetooth functionality.';
                elements.bluetoothInfo.className = 'mb-4 p-4 bg-yellow-50 border-l-4 border-yellow-500 rounded-lg';
                
                // Add simulation badges to buttons
                elements.scanBluetoothButton.innerHTML += '<span class="simulated-badge">Simulated</span>';
                elements.makeDiscoverableButton.innerHTML += '<span class="simulated-badge">Simulated</span>';
            }
        }

        // Set up event listeners
        function setupEventListeners() {
            // Auth events
            elements.showRegister.addEventListener('click', () => {
                elements.loginForm.classList.add('hidden');
                elements.registerForm.classList.remove('hidden');
            });
            
            elements.showLogin.addEventListener('click', () => {
                elements.registerForm.classList.add('hidden');
                elements.loginForm.classList.remove('hidden');
            });
            
            elements.loginButton.addEventListener('click', handleLogin);
            elements.registerButton.addEventListener('click', handleRegister);
            
            // Bluetooth events
            elements.scanBluetoothButton.addEventListener('click', scanForDevices);
            elements.makeDiscoverableButton.addEventListener('click', makeDiscoverable);
            
            // Message events
            elements.sendButton.addEventListener('click', sendMessage);
            elements.messageInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') sendMessage();
            });
            
            // Media events
            elements.mediaButton.addEventListener('click', () => elements.mediaInput.click());
            elements.mediaInput.addEventListener('change', handleMediaUpload);
        }

        // Handle user registration
        function handleRegister() {
            const username = document.getElementById('register-username').value;
            const password = document.getElementById('register-password').value;
            const confirm = document.getElementById('register-confirm').value;
            
            if (!username || !password) {
                alert('Please enter both username and password');
                return;
            }
            
            if (password !== confirm) {
                alert('Passwords do not match');
                return;
            }
            
            // Get existing users or initialize empty object
            const users = JSON.parse(localStorage.getItem(STORAGE_KEYS.USERS) || '{}');
            
            if (users[username]) {
                alert('Username already exists');
                return;
            }
            
            // Store user (in a real app, you'd hash the password)
            users[username] = { password, createdAt: new Date().toISOString() };
            localStorage.setItem(STORAGE_KEYS.USERS, JSON.stringify(users));
            
            alert('Registration successful! Please login.');
            elements.registerForm.classList.add('hidden');
            elements.loginForm.classList.remove('hidden');
        }

        // Handle user login
        function handleLogin() {
            const username = document.getElementById('login-username').value;
            const password = document.getElementById('login-password').value;
            
            if (!username || !password) {
                alert('Please enter both username and password');
                return;
            }
            
            // Get existing users
            const users = JSON.parse(localStorage.getItem(STORAGE_KEYS.USERS) || '{}');
            
            if (!users[username] || users[username].password !== password) {
                alert('Invalid username or password');
                return;
            }
            
            // Login successful
            appState.currentUser = username;
            localStorage.setItem(STORAGE_KEYS.CURRENT_USER, username);
            
            // Derive encryption key from password (simplified for demo)
            appState.encryptionKey = CryptoJS.SHA256(password).toString();
            
            elements.authSection.classList.add('hidden');
            elements.mainSection.classList.remove('hidden');
            
            loadMessages();
        }

        // Scan for Bluetooth devices
        async function scanForDevices() {
            if (appState.bluetoothSupported) {
                // Real Web Bluetooth API implementation
                try {
                    elements.scanBluetoothButton.disabled = true;
                    elements.scanBluetoothButton.innerHTML = '<span class="connecting"></span><span class="ml-2">Scanning...</span>';
                    
                    console.log('Requesting Bluetooth Device...');
                    const device = await navigator.bluetooth.requestDevice({
                        acceptAllDevices: true,
                        optionalServices: ['battery_service']
                    });
                    
                    console.log('> Name:             ' + device.name);
                    console.log('> ID:               ' + device.id);
                    console.log('> Connected:        ' + device.gatt.connected);
                    
                    // Connect to device
                    elements.scanBluetoothButton.innerHTML = '<span class="connecting"></span><span class="ml-2">Connecting...</span>';
                    
                    const deviceObject = {
                        id: device.id,
                        name: device.name || 'Unknown Device',
                        type: 'bluetooth',
                        device: device
                    };
                    
                    connectToDevice(deviceObject);
                    
                } catch (error) {
                    console.error('Bluetooth error:', error);
                    alert('Error with Bluetooth: ' + error.message);
                } finally {
                    elements.scanBluetoothButton.disabled = false;
                    elements.scanBluetoothButton.innerHTML = '<span>üîç</span><span class="ml-2">Scan for Devices</span>';
                }
            } else {
                // Simulated Bluetooth scanning
                elements.scanBluetoothButton.disabled = true;
                elements.scanBluetoothButton.innerHTML = '<span class="connecting"></span><span class="ml-2">Scanning...</span>';
                
                // Simulate scanning delay
                setTimeout(() => {
                    updateBluetoothDevicesList(appState.simulatedDevices);
                    elements.scanBluetoothButton.disabled = false;
                    elements.scanBluetoothButton.innerHTML = '<span>üîç</span><span class="ml-2">Scan for Devices</span><span class="simulated-badge">Simulated</span>';
                }, 2000);
            }
        }

        // Make device discoverable
        async function makeDiscoverable() {
            if (appState.bluetoothSupported) {
                // In a real implementation, you would use the Web Bluetooth API
                // to make the device discoverable, but this isn't directly supported
                alert('Your device is now discoverable to nearby Bluetooth devices.');
            } else {
                // Simulated discoverable mode
                elements.makeDiscoverableButton.disabled = true;
                elements.makeDiscoverableButton.innerHTML = '<span class="connecting"></span><span class="ml-2">Discoverable...</span>';
                
                // Simulate being discoverable
                setTimeout(() => {
                    alert('Your device is now discoverable to nearby Bluetooth devices. Other users can now find and connect to your device.');
                    elements.makeDiscoverableButton.disabled = false;
                    elements.makeDiscoverableButton.innerHTML = '<span>üì±</span><span class="ml-2">Make Discoverable</span><span class="simulated-badge">Simulated</span>';
                    
                    // Simulate another device discovering us
                    simulateDeviceDiscovery();
                }, 1500);
            }
        }

        // Simulate device discovery
        function simulateDeviceDiscovery() {
            // In a real implementation, this would be handled by the Bluetooth API
            // For demo purposes, we'll simulate finding a device after a delay
            setTimeout(() => {
                const newDevice = {
                    id: 'discovered-device',
                    name: 'Discovered Phone',
                    type: 'phone'
                };
                
                // Add to simulated devices if not already there
                if (!appState.simulatedDevices.some(d => d.id === newDevice.id)) {
                    appState.simulatedDevices.push(newDevice);
                    updateBluetoothDevicesList(appState.simulatedDevices);
                }
            }, 3000);
        }

        // Update Bluetooth devices list
        function updateBluetoothDevicesList(devices) {
            if (devices.length === 0) {
                elements.bluetoothDevices.innerHTML = '<p class="text-gray-500 text-center py-4">No devices found.</p>';
                return;
            }
            
            elements.bluetoothDevices.innerHTML = '';
            devices.forEach(device => {
                const deviceElement = document.createElement('div');
                deviceElement.className = 'bluetooth-device p-2 border-b';
                
                // Get device icon based on type
                let icon = 'üì±'; // default phone icon
                if (device.type === 'tablet') icon = 'üìü';
                if (device.type === 'laptop') icon = 'üíª';
                if (device.type === 'watch') icon = '‚åö';
                if (device.type === 'bluetooth') icon = 'üì∂';
                
                deviceElement.innerHTML = `
                    <div class="flex justify-between items-center">
                        <div class="flex items-center">
                            <span class="device-icon">${icon}</span>
                            <span>${device.name}</span>
                        </div>
                        <button class="connect-device bg-blue-500 hover:bg-blue-700 text-white text-xs font-bold py-1 px-2 rounded" data-id="${device.id}">Connect</button>
                    </div>
                `;
                elements.bluetoothDevices.appendChild(deviceElement);
                
                // Add event listener to connect button
                deviceElement.querySelector('.connect-device').addEventListener('click', () => {
                    connectToDevice(device);
                });
            });
        }

        // Connect to a device
        function connectToDevice(device) {
            if (appState.bluetoothSupported && device.device) {
                // Real Web Bluetooth API implementation
                elements.bluetoothDevices.querySelectorAll('.connect-device').forEach(btn => {
                    btn.disabled = true;
                    btn.textContent = 'Connecting...';
                });
                
                device.device.gatt.connect()
                .then(server => {
                    console.log('Getting Service...');
                    return server.getPrimaryService('battery_service');
                })
                .then(service => {
                    console.log('Getting Characteristic...');
                    return service.getCharacteristic('battery_level');
                })
                .then(characteristic => {
                    console.log('Reading Battery Level...');
                    return characteristic.readValue();
                })
                .then(value => {
                    console.log('Battery percentage: ' + value.getUint8(0) + '%');
                    
                    appState.connectedDevices.set(device.id, device);
                    
                    // Save connected devices to localStorage
                    const devicesArray = Array.from(appState.connectedDevices.values());
                    localStorage.setItem(STORAGE_KEYS.DEVICES, JSON.stringify(devicesArray));
                    
                    updateConnectedDevicesList();
                    updateConnectionStatus(true);
                    
                    // Simulate receiving a welcome message
                    simulateIncomingMessage({
                        id: Date.now(),
                        sender: device.name,
                        text: `Connected to ${device.name}`,
                        timestamp: new Date().toISOString(),
                        type: 'text'
                    });
                    
                    // Reset connect buttons
                    elements.bluetoothDevices.querySelectorAll('.connect-device').forEach(btn => {
                        btn.disabled = false;
                        btn.textContent = 'Connect';
                    });
                })
                .catch(error => {
                    console.error('Connection error:', error);
                    alert('Error connecting to device: ' + error.message);
                    
                    // Reset connect buttons
                    elements.bluetoothDevices.querySelectorAll('.connect-device').forEach(btn => {
                        btn.disabled = false;
                        btn.textContent = 'Connect';
                    });
                });
            } else {
                // Simulated connection
                elements.bluetoothDevices.querySelectorAll('.connect-device').forEach(btn => {
                    btn.disabled = true;
                    btn.textContent = 'Connecting...';
                });
                
                // Simulate connection process
                setTimeout(() => {
                    appState.connectedDevices.set(device.id, device);
                    
                    // Save connected devices to localStorage
                    const devicesArray = Array.from(appState.connectedDevices.values());
                    localStorage.setItem(STORAGE_KEYS.DEVICES, JSON.stringify(devicesArray));
                    
                    updateConnectedDevicesList();
                    updateConnectionStatus(true);
                    
                    // Simulate receiving a welcome message
                    simulateIncomingMessage({
                        id: Date.now(),
                        sender: device.name,
                        text: `Connected to ${device.name}`,
                        timestamp: new Date().toISOString(),
                        type: 'text'
                    });
                    
                    // Reset connect buttons
                    elements.bluetoothDevices.querySelectorAll('.connect-device').forEach(btn => {
                        btn.disabled = false;
                        btn.textContent = 'Connect';
                    });
                }, 1500);
            }
        }

        // Update connected devices list
        function updateConnectedDevicesList() {
            if (appState.connectedDevices.size === 0) {
                elements.connectedDevices.innerHTML = '<p class="text-gray-500 text-center py-4">No devices connected.</p>';
                return;
            }
            
            elements.connectedDevices.innerHTML = '';
            appState.connectedDevices.forEach((device, id) => {
                // Get device icon based on type
                let icon = 'üì±'; // default phone icon
                if (device.type === 'tablet') icon = 'üìü';
                if (device.type === 'laptop') icon = 'üíª';
                if (device.type === 'watch') icon = '‚åö';
                if (device.type === 'bluetooth') icon = 'üì∂';
                
                const deviceElement = document.createElement('div');
                deviceElement.className = 'connected-device p-2 border-b';
                deviceElement.innerHTML = `
                    <div class="flex items-center">
                        <span class="connection-status connected"></span>
                        <span class="device-icon">${icon}</span>
                        <span>${device.name}</span>
                        <button class="ml-auto disconnect-device text-red-500 hover:text-red-700 text-xs font-bold py-1 px-2" data-id="${device.id}">Disconnect</button>
                    </div>
                `;
                elements.connectedDevices.appendChild(deviceElement);
                
                // Add event listener to disconnect button
                deviceElement.querySelector('.disconnect-device').addEventListener('click', () => {
                    disconnectDevice(device.id);
                });
            });
        }

        // Disconnect from a device
        function disconnectDevice(deviceId) {
            const device = appState.connectedDevices.get(deviceId);
            
            if (appState.bluetoothSupported && device.device) {
                // Real Web Bluetooth API disconnection
                if (device.device.gatt.connected) {
                    device.device.gatt.disconnect();
                    console.log('Bluetooth Device disconnected');
                }
            }
            
            appState.connectedDevices.delete(deviceId);
            
            // Update localStorage
            const devicesArray = Array.from(appState.connectedDevices.values());
            localStorage.setItem(STORAGE_KEYS.DEVICES, JSON.stringify(devicesArray));
            
            updateConnectedDevicesList();
            
            if (appState.connectedDevices.size === 0) {
                updateConnectionStatus(false);
            }
            
            // Simulate disconnection message
            simulateIncomingMessage({
                id: Date.now(),
                sender: 'System',
                text: `Disconnected from ${device.name}`,
                timestamp: new Date().toISOString(),
                type: 'text'
            });
        }

        // Update connection status UI
        function updateConnectionStatus(connected) {
            appState.isConnected = connected;
            if (connected) {
                elements.connectionStatus.textContent = 'Connected';
                elements.connectionStatus.classList.remove('bg-red-500');
                elements.connectionStatus.classList.add('bg-green-500');
            } else {
                elements.connectionStatus.textContent = 'Disconnected';
                elements.connectionStatus.classList.remove('bg-green-500');
                elements.connectionStatus.classList.add('bg-red-500');
            }
        }

        // Encrypt message
        function encryptMessage(text) {
            return CryptoJS.AES.encrypt(text, appState.encryptionKey).toString();
        }

        // Decrypt message
        function decryptMessage(ciphertext) {
            try {
                const bytes = CryptoJS.AES.decrypt(ciphertext, appState.encryptionKey);
                return bytes.toString(CryptoJS.enc.Utf8);
            } catch (e) {
                console.error('Decryption error:', e);
                return '[Unable to decrypt message]';
            }
        }

        // Send message
        function sendMessage() {
            const messageText = elements.messageInput.value.trim();
            if (!messageText) return;
            
            if (appState.connectedDevices.size === 0) {
                alert('Not connected to any devices. Please connect to a Bluetooth device first.');
                return;
            }
            
            const message = {
                id: Date.now(),
                sender: appState.currentUser,
                text: messageText,
                timestamp: new Date().toISOString(),
                type: 'text'
            };
            
            // Encrypt message
            const encryptedMessage = encryptMessage(messageText);
            
            // In a real implementation, this would send via Bluetooth
            // For this demo, we'll just store it locally and simulate sending
            simulateSendViaBluetooth(message);
            saveMessage(message);
            displayMessage(message);
            
            // Clear input
            elements.messageInput.value = '';
        }

        // Simulate sending via Bluetooth
        function simulateSendViaBluetooth(message) {
            // In a real implementation, this would send data via Bluetooth
            // For demo purposes, we'll just log it and simulate responses
            console.log('Sending via Bluetooth:', message);
            
            // Simulate sending to all connected devices
            appState.connectedDevices.forEach((device, id) => {
                console.log(`Sent to ${device.name}:`, message);
                
                // Simulate responses from devices after a delay
                if (Math.random() > 0.7) {
                    setTimeout(() => {
                        simulateIncomingMessage({
                            id: Date.now() + Math.random(),
                            sender: device.name,
                            text: 'Received your message!',
                            timestamp: new Date().toISOString(),
                            type: 'text'
                        });
                    }, 1000 + Math.random() * 2000);
                }
            });
        }

        // Handle media upload
        function handleMediaUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            // Check if file is image or video
            const isImage = file.type.startsWith('image/');
            const isVideo = file.type.startsWith('video/');
            
            if (!isImage && !isVideo) {
                alert('Please select an image or video file');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const message = {
                    id: Date.now(),
                    sender: appState.currentUser,
                    text: isImage ? 'Sent an image' : 'Sent a video',
                    media: e.target.result,
                    timestamp: new Date().toISOString(),
                    type: isImage ? 'image' : 'video'
                };
                
                // In a real implementation, this would send via Bluetooth
                // For this demo, we'll just store it locally and simulate sending
                simulateSendViaBluetooth(message);
                saveMessage(message);
                displayMessage(message);
                
                // Reset file input
                elements.mediaInput.value = '';
            };
            
            reader.readAsDataURL(file);
        }

        // Save message to localStorage
        function saveMessage(message) {
            const messages = JSON.parse(localStorage.getItem(STORAGE_KEYS.MESSAGES) || '[]');
            messages.push(message);
            localStorage.setItem(STORAGE_KEYS.MESSAGES, JSON.stringify(messages));
        }

        // Load messages from localStorage
        function loadMessages() {
            const messages = JSON.parse(localStorage.getItem(STORAGE_KEYS.MESSAGES) || '[]');
            elements.messagesContainer.innerHTML = '';
            
            messages.forEach(message => {
                displayMessage(message);
            });
        }

        // Display message in chat
        function displayMessage(message) {
            const messageEl = document.createElement('div');
            messageEl.classList.add('mb-4');
            
            const isOwnMessage = message.sender === appState.currentUser;
            
            if (message.type === 'text') {
                const decryptedText = isOwnMessage ? message.text : decryptMessage(message.text);
                
                messageEl.innerHTML = `
                    <div class="flex ${isOwnMessage ? 'justify-end' : 'justify-start'}">
                        <div class="chat-bubble-${isOwnMessage ? 'sent' : 'received'} bg-${isOwnMessage ? 'blue-500' : 'gray-200'} text-${isOwnMessage ? 'white' : 'gray-800'} px-4 py-2">
                            <p class="text-sm">${decryptedText}</p>
                            <span class="text-xs opacity-75 block mt-1">${formatTime(message.timestamp)} ‚Ä¢ ${message.sender}</span>
                        </div>
                    </div>
                `;
            } else if (message.type === 'image' || message.type === 'video') {
                messageEl.innerHTML = `
                    <div class="flex ${isOwnMessage ? 'justify-end' : 'justify-start'}">
                        <div class="max-w-xs">
                            <${message.type === 'image' ? 'img' : 'video'} 
                                src="${message.media}" 
                                class="rounded-lg max-w-full h-auto" 
                                ${message.type === 'video' ? 'controls' : ''}
                            >
                            <p class="text-sm mt-1 text-gray-600">${message.text}</p>
                            <span class="text-xs opacity-75 block mt-1">${formatTime(message.timestamp)} ‚Ä¢ ${message.sender}</span>
                        </div>
                    </div>
                `;
            }
            
            elements.messagesContainer.appendChild(messageEl);
            elements.messagesContainer.scrollTop = elements.messagesContainer.scrollHeight;
        }

        // Format timestamp
        function formatTime(timestamp) {
            const date = new Date(timestamp);
            return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        }

        // Simulate incoming message
        function simulateIncomingMessage(message) {
            // For demo purposes, we'll encrypt the message if it's text
            if (message.type === 'text' && message.sender !== 'System') {
                message.text = encryptMessage(message.text);
            }
            
            saveMessage(message);
            displayMessage(message);
        }

        // Initialize the app when the DOM is loaded
        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>